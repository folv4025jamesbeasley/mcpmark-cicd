name: Pull Request Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

env:
  NODE_VERSION: '18'

jobs:
  code-quality:
    name: code-quality
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint
        id: eslint
        run: |
          echo "Running ESLint checks..."
          npm run lint > eslint-results.txt 2>&1 || echo "ESLINT_FAILED=true" >> $GITHUB_OUTPUT
          echo "ESLINT_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat eslint-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Run Prettier check
        id: prettier
        run: |
          echo "Running Prettier formatting checks..."
          npx prettier --check src/ > prettier-results.txt 2>&1 || echo "PRETTIER_FAILED=true" >> $GITHUB_OUTPUT
          echo "PRETTIER_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat prettier-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Post Code Quality Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const eslintOutput = `${{ steps.eslint.outputs.ESLINT_OUTPUT }}`;
            const prettierOutput = `${{ steps.prettier.outputs.PRETTIER_OUTPUT }}`;
            const eslintFailed = '${{ steps.eslint.outputs.ESLINT_FAILED }}' === 'true';
            const prettierFailed = '${{ steps.prettier.outputs.PRETTIER_FAILED }}' === 'true';
            
            const eslintStatus = eslintFailed ? '‚ùå FAILED' : '‚úÖ PASSED';
            const prettierStatus = prettierFailed ? '‚ùå FAILED' : '‚úÖ PASSED';
            
            const body = `## üßπ Code Quality Report
            
            ### ESLint Status: ${eslintStatus}
            \`\`\`
            ${eslintOutput || 'No ESLint issues found'}
            \`\`\`
            
            ### Prettier Status: ${prettierStatus}
            \`\`\`
            ${prettierOutput || 'All files are properly formatted'}
            \`\`\`
            
            **Overall Status**: ${eslintFailed || prettierFailed ? '‚ùå Issues found' : '‚úÖ All checks passed'}
            
            ---
            *Generated by PR Automation Workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  testing-suite:
    name: testing-suite
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run test suite with coverage
        id: tests
        run: |
          echo "Running full test suite..."
          npm run test:coverage > test-results.txt 2>&1 || echo "TESTS_FAILED=true" >> $GITHUB_OUTPUT
          echo "TEST_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat test-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Extract coverage summary
          if [ -f coverage/coverage-summary.json ]; then
            echo "COVERAGE_SUMMARY<<EOF" >> $GITHUB_OUTPUT
            cat coverage/coverage-summary.json >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7
          
      - name: Post Test Coverage Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const testOutput = `${{ steps.tests.outputs.TEST_OUTPUT }}`;
            const testsFailed = '${{ steps.tests.outputs.TESTS_FAILED }}' === 'true';
            const coverageSummary = `${{ steps.tests.outputs.COVERAGE_SUMMARY }}`;
            
            let coverageInfo = 'Coverage data not available';
            if (coverageSummary) {
              try {
                const summary = JSON.parse(coverageSummary);
                const total = summary.total;
                if (total) {
                  coverageInfo = `Lines: ${total.lines.pct}%, Functions: ${total.functions.pct}%, Branches: ${total.branches.pct}%, Statements: ${total.statements.pct}%`;
                }
              } catch (e) {
                coverageInfo = 'Coverage summary available in artifacts';
              }
            }
            
            const testStatus = testsFailed ? '‚ùå FAILED' : '‚úÖ PASSED';
            
            const body = `## üß™ Test Coverage Report
            
            ### Test Status: ${testStatus}
            
            ### Coverage Summary
            ${coverageInfo}
            
            ### Test Output
            \`\`\`
            ${testOutput || 'Test execution completed'}
            \`\`\`
            
            **Overall Status**: ${testsFailed ? '‚ùå Tests failed' : '‚úÖ All tests passed'}
            
            üìä **Coverage Report**: Available in workflow artifacts
            
            ---
            *Generated by PR Automation Workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run dependency vulnerability check
        id: depscan
        run: |
          echo "Running dependency vulnerability scan..."
          npm audit --audit-level=moderate > audit-results.txt 2>&1 || echo "AUDIT_FAILED=true" >> $GITHUB_OUTPUT
          echo "AUDIT_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat audit-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Scan for secrets in code changes
        id: secretscan
        run: |
          echo "Scanning for potential secrets..."
          # Simple secret pattern detection
          if git diff --name-only HEAD~1 HEAD | xargs grep -l -E '(password|secret|key|token)' 2>/dev/null; then
            echo "SECRETS_FOUND=true" >> $GITHUB_OUTPUT
            echo "Potential secrets found in changed files" > secret-results.txt
          else
            echo "SECRETS_FOUND=false" >> $GITHUB_OUTPUT
            echo "No obvious secrets detected" > secret-results.txt
          fi
          echo "SECRET_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat secret-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Post Security Scan Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const auditOutput = `${{ steps.depscan.outputs.AUDIT_OUTPUT }}`;
            const secretOutput = `${{ steps.secretscan.outputs.SECRET_OUTPUT }}`;
            const auditFailed = '${{ steps.depscan.outputs.AUDIT_FAILED }}' === 'true';
            const secretsFound = '${{ steps.secretscan.outputs.SECRETS_FOUND }}' === 'true';
            
            const auditStatus = auditFailed ? '‚ö†Ô∏è VULNERABILITIES FOUND' : '‚úÖ SECURE';
            const secretStatus = secretsFound ? '‚ö†Ô∏è POTENTIAL SECRETS DETECTED' : '‚úÖ NO SECRETS FOUND';
            
            const body = `## üîí Security Scan Report
            
            ### Dependencies Status: ${auditStatus}
            \`\`\`
            ${auditOutput || 'No dependency vulnerabilities found'}
            \`\`\`
            
            ### Secrets Detection: ${secretStatus}
            \`\`\`
            ${secretOutput || 'Scan completed'}
            \`\`\`
            
            **Overall Security Status**: ${auditFailed || secretsFound ? '‚ö†Ô∏è Security issues detected' : '‚úÖ Security scan passed'}
            
            ### Recommendations:
            ${auditFailed ? '- Update vulnerable dependencies' : '- Dependencies are up to date'}
            ${secretsFound ? '- Review and remove hardcoded secrets' : '- No hardcoded secrets detected'}
            
            ---
            *Generated by PR Automation Workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  build-validation:
    name: build-validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        id: build
        run: |
          echo "Building application..."
          npm run build > build-results.txt 2>&1 || echo "BUILD_FAILED=true" >> $GITHUB_OUTPUT
          echo "BUILD_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat build-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Start application for validation
        id: appstart
        run: |
          echo "Starting application for validation..."
          npm start &
          APP_PID=$!
          sleep 5
          
          # Test health endpoint
          if curl -f -s http://localhost:3000/health > /dev/null; then
            echo "HEALTH_CHECK=true" >> $GITHUB_OUTPUT
            echo "Health check: ‚úÖ PASSED" > health-results.txt
          else
            echo "HEALTH_CHECK=false" >> $GITHUB_OUTPUT
            echo "Health check: ‚ùå FAILED" > health-results.txt
          fi
          
          # Kill the application
          kill $APP_PID || true
          sleep 2
          
          echo "HEALTH_OUTPUT<<EOF" >> $GITHUB_OUTPUT
          cat health-results.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true
        
      - name: Create deployment preview
        if: always()
        run: |
          mkdir -p deployment-preview
          echo "Application: mcpmark-cicd" > deployment-preview/deployment-info.txt
          echo "Build Time: $(date)" >> deployment-preview/deployment-info.txt
          echo "Node Version: ${{ env.NODE_VERSION }}" >> deployment-preview/deployment-info.txt
          echo "Commit: ${{ github.sha }}" >> deployment-preview/deployment-info.txt
          
      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-preview
          path: deployment-preview/
          retention-days: 7
          
      - name: Post Build Validation Report
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const buildOutput = `${{ steps.build.outputs.BUILD_OUTPUT }}`;
            const healthOutput = `${{ steps.appstart.outputs.HEALTH_OUTPUT }}`;
            const buildFailed = '${{ steps.build.outputs.BUILD_FAILED }}' === 'true';
            const healthCheck = '${{ steps.appstart.outputs.HEALTH_CHECK }}' === 'true';
            
            const buildStatus = buildFailed ? '‚ùå FAILED' : '‚úÖ PASSED';
            const healthStatus = healthCheck ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            const body = `## üèóÔ∏è Build Validation
            
            ### Build Status: ${buildStatus}
            \`\`\`
            ${buildOutput || 'Build completed successfully'}
            \`\`\`
            
            ### Application Health Check: ${healthStatus}
            \`\`\`
            ${healthOutput || 'Health check not performed'}
            \`\`\`
            
            ### Deployment Preview
            - **Application**: mcpmark-cicd
            - **Node Version**: ${{ env.NODE_VERSION }}
            - **Commit**: ${{ github.sha }}
            - **Build Time**: $(date)
            
            **Overall Build Status**: ${buildFailed || !healthCheck ? '‚ùå Build validation failed' : '‚úÖ Build validation passed'}
            
            üì¶ **Deployment Artifacts**: Available in workflow artifacts
            
            ---
            *Generated by PR Automation Workflow*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });